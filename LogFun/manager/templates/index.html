<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LogFun Dashboard</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background: #f4f7f6;
            margin: 0;
            padding: 20px;
            color: #333;
        }

        .container {
            max-width: 1100px;
            margin: 0 auto;
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .app-selector-wrapper {
            background: white;
            padding: 10px 15px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        select {
            padding: 5px 10px;
            border-radius: 4px;
            border: 1px solid #ddd;
            outline: none;
        }

        .card-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .card {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .card h3 {
            margin: 0 0 10px 0;
            font-size: 12px;
            color: #888;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .card .value {
            font-size: 28px;
            font-weight: bold;
            color: #2c3e50;
        }

        .card .sub {
            font-size: 12px;
            color: #aaa;
            margin-top: 5px;
        }

        .status-active {
            color: #27ae60;
            font-weight: bold;
        }

        .section {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
        }

        .section h2 {
            margin-top: 0;
            font-size: 18px;
            color: #2c3e50;
            border-left: 4px solid #3498db;
            padding-left: 10px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
        }

        th,
        td {
            text-align: left;
            padding: 12px;
            border-bottom: 1px solid #eee;
        }

        th {
            color: #888;
            font-weight: 500;
            font-size: 13px;
            background: #fafafa;
        }

        .badge {
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: bold;
            text-transform: uppercase;
        }

        .badge-func {
            background: #e1f5fe;
            color: #0288d1;
        }

        .badge-tpl {
            background: #f3e5f5;
            color: #7b1fa2;
        }

        .badge-mute {
            background: #ffebee;
            color: #c62828;
        }

        .btn {
            padding: 5px 12px;
            border-radius: 4px;
            border: none;
            cursor: pointer;
            font-size: 12px;
            transition: 0.2s;
        }

        .btn-mute {
            background: #ff7675;
            color: white;
        }

        .btn-mute:hover {
            background: #d63031;
        }

        .btn-unmute {
            background: #55efc4;
            color: #006266;
        }

        .btn-unmute:hover {
            background: #00b894;
        }

        code {
            font-family: Consolas, Monaco, monospace;
            background: #f8f9fa;
            padding: 2px 4px;
            color: #e83e8c;
        }
    </style>
</head>

<body>
    <div class="container">
        <div class="header">
            <h1>LogFun Manager</h1>
            <div class="app-selector-wrapper">
                <label for="app-select">Current App:</label>
                <select id="app-select" onchange="refreshAll()">
                    <option value="root">root</option>
                </select>
                <div id="connection-status" class="status-active">‚óè Connected</div>
            </div>
        </div>

        <div class="card-grid">
            <div class="card">
                <h3>Real-time QPS</h3>
                <div class="value" id="qps-val">0</div>
                <div class="sub">Logs / Second</div>
            </div>
            <div class="card">
                <h3>Total Logs</h3>
                <div class="value" id="total-val">0</div>
                <div class="sub">Processed Logs</div>
            </div>
            <div class="card">
                <h3>Uptime</h3>
                <div class="value" id="uptime-val">0s</div>
                <div class="sub">System Running</div>
            </div>
            <div class="card">
                <h3>Active Strategy</h3>
                <div class="value" id="strategy-val">-</div>
                <div class="sub" id="strategy-sub">Algorithm: -</div>
            </div>
        </div>

        <div class="section">
            <h2>Active Suppression (Blacklist)</h2>
            <p style="color:#888; font-size:13px;">IDs currently blocked by the Balancer algorithm.</p>
            <table id="mute-table">
                <thead>
                    <tr>
                        <th>Type</th>
                        <th>Target ID</th>
                        <th>Metadata</th>
                        <th>Action</th>
                    </tr>
                </thead>
                <tbody id="mute-body">
                    <tr>
                        <td colspan="4" style="text-align:center; color:#ccc;">No active suppressions</td>
                    </tr>
                </tbody>
            </table>
        </div>

        <div class="section">
            <h2>Metadata Explorer</h2>
            <p style="color:#888; font-size:13px;">Functions and templates registered by this App.</p>
            <table id="registry-table">
                <thead>
                    <tr>
                        <th>Type</th>
                        <th>ID</th>
                        <th>Identifier / Content</th>
                        <th>Control</th>
                    </tr>
                </thead>
                <tbody id="registry-body">
                    <tr>
                        <td colspan="4" style="text-align:center; color:#ccc;">Loading registry...</td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>

    <script>
        let currentRegistry = { functions: {}, templates: {} };

        function fetchStatus() {
            fetch('/api/status')
                .then(r => r.json())
                .then(data => {
                    document.getElementById('qps-val').innerText = data.qps;
                    document.getElementById('total-val').innerText = data.total_logs.toLocaleString();
                    document.getElementById('uptime-val').innerText = formatTime(data.uptime);
                });
        }

        function fetchBalancer() {
            fetch('/api/balancer')
                .then(r => r.json())
                .then(data => {
                    document.getElementById('strategy-val').innerText = data.active_strategy.toUpperCase();
                    document.getElementById('strategy-sub').innerText = 'Params: ' + JSON.stringify(data.params);
                });
        }

        function fetchRegistry() {
            const app = document.getElementById('app-select').value;
            fetch(`/api/registry?app=${app}`)
                .then(r => r.json())
                .then(data => {
                    currentRegistry = data;
                    const body = document.getElementById('registry-body');
                    body.innerHTML = '';

                    // Functions
                    for (let id in data.functions) {
                        renderRow(body, 'Function', id, data.functions[id], 'badge-func');
                    }
                    // Templates
                    for (let id in data.templates) {
                        renderRow(body, 'Template', id, data.templates[id], 'badge-tpl');
                    }
                });
        }

        function renderRow(container, type, id, content, badgeClass) {
            const row = document.createElement('tr');
            row.innerHTML = `
                <td><span class="badge ${badgeClass}">${type}</span></td>
                <td><code>${id}</code></td>
                <td style="font-family:monospace; font-size:12px;">${content}</td>
                <td><button class="btn btn-mute" onclick="sendControl('${id}', '${type}', 'mute')">Mute</button></td>
            `;
            container.appendChild(row);
        }

        function fetchMuteList() {
            const app = document.getElementById('app-select').value;
            fetch(`/api/mute_list?app=${app}`)
                .then(r => r.json())
                .then(data => {
                    const body = document.getElementById('mute-body');
                    body.innerHTML = '';

                    if (!data.muted_funcs || data.muted_funcs.length === 0) {
                        body.innerHTML = '<tr><td colspan="4" style="text-align:center; color:#ccc;">No active suppressions</td></tr>';
                        return;
                    }

                    data.muted_funcs.forEach(fid => {
                        const name = currentRegistry.functions[fid] || 'Unknown Function';
                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td><span class="badge badge-mute">Muted</span></td>
                            <td><code>${fid}</code></td>
                            <td>${name}</td>
                            <td><button class="btn btn-unmute" onclick="sendControl('${fid}', 'Function', 'unmute')">Unmute</button></td>
                        `;
                        body.appendChild(row);
                    });
                });
        }

        function sendControl(id, type, action) {
            const app = document.getElementById('app-select').value;
            fetch('/api/control', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ app, id, type, action })
            }).then(r => r.json()).then(res => {
                console.log('Control sent:', res);
                fetchMuteList(); // Refresh
            });
        }

        function formatTime(seconds) {
            const h = Math.floor(seconds / 3600);
            const m = Math.floor((seconds % 3600) / 60);
            const s = seconds % 60;
            return `${h}h ${m}m ${s}s`;
        }

        function refreshAll() {
            fetchStatus();
            fetchBalancer();
            fetchRegistry();
            fetchMuteList();
        }

        // Intervals
        setInterval(fetchStatus, 1000);
        setInterval(fetchBalancer, 3000);
        setInterval(fetchMuteList, 3000);
        setInterval(fetchRegistry, 10000); // Registry doesn't change often

        // Initial Load
        refreshAll();
    </script>
</body>

</html>